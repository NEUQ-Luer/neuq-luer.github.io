{"title":"ORACLE之自动行号功能","date":"2019-07-31T02:29:33.000Z","thumbnail":"/img//BingPaper3.jpg","link":"post/ORACLE之自动行号功能","tags":["ORACLE"],"categories":["技术向"],"updated":"2019-07-31T02:49:14.946Z","content":"<h2 id=\"方法一\">方法一<a href=\"post/ORACLE之自动行号功能#方法一\"></a></h2><p>加几个块级触发器  </p>\n<p>Key-Crerec:</p>\n<figure class=\"highlight plain\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DECLARE LINE NUMBER;</span><br><span class=\"line\">BEGIN</span><br><span class=\"line\">    LINE := :SYSTEM.CURSOR_RECORD;</span><br><span class=\"line\">    LOOP </span><br><span class=\"line\">        IF </span><br><span class=\"line\">            :SYSTEM.LAST_RECORD = &apos;TRUE&apos; </span><br><span class=\"line\">        THEN EXIT;</span><br><span class=\"line\">        ELSE </span><br><span class=\"line\">            NEXT_RECORD; </span><br><span class=\"line\">            :blk.ID := :SYSTEM.CURSOR_RECORD + 1; </span><br><span class=\"line\">        END IF; </span><br><span class=\"line\">    END LOOP;</span><br><span class=\"line\">    GO_RECORD(LINE);</span><br><span class=\"line\">    CREATE_RECORD;</span><br><span class=\"line\">    :blk.ID := :SYSTEM.CURSOR_RECORD;</span><br><span class=\"line\">    END;</span><br></pre></td></tr></table></div></figure>\n\n<p>Key - Delrec：</p>\n<figure class=\"highlight plain\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DECLARE LINE NUMBER;</span><br><span class=\"line\">BEGIN</span><br><span class=\"line\">    DELETE_RECORD;</span><br><span class=\"line\">    LINE := :SYSTEM.CURSOR_RECORD;</span><br><span class=\"line\">    LOOP </span><br><span class=\"line\">        :blk.ID := :SYSTEM.CURSOR_RECORD; </span><br><span class=\"line\">        IF </span><br><span class=\"line\">            :SYSTEM.LAST_RECORD = &apos;TRUE&apos; </span><br><span class=\"line\">        THEN </span><br><span class=\"line\">            EXIT; </span><br><span class=\"line\">        ELSE </span><br><span class=\"line\">            NEXT_RECORD; </span><br><span class=\"line\">        END IF; </span><br><span class=\"line\">    END LOOP;</span><br><span class=\"line\">    GO_RECORD(LINE);</span><br><span class=\"line\">END;</span><br></pre></td></tr></table></div></figure>\n\n<p>When-Create-Record：</p>\n<figure class=\"highlight plain\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">:blk.ID := :SYSTEM.TRIGGER_RECORD;</span><br></pre></td></tr></table></div></figure>\n\n<p>为了防止按F11时也生成序号,影响查询,可以在生成前加入以下条件:</p>\n<figure class=\"highlight plain\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IF (:SYSTEM.MODE != ‘ENTER-QUERY’) THEN</span><br></pre></td></tr></table></div></figure>\n\n<hr>\n<h2 id=\"方法二：\">方法二：<a href=\"post/ORACLE之自动行号功能#方法二：\"></a></h2><p>只需要将“序号”定义成公式，并将公式设置为：</p>\n<figure class=\"highlight plain\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">get_block_property(&apos;block_name&apos;,current_record)</span><br></pre></td></tr></table></div></figure>\n\n<p>就可以实现了，或者把这行语句放到 “When-Create-Record” 触发器中。  </p>\n<blockquote>\n<p>缺点：增改删时，行号不能自动刷新。</p>\n</blockquote>\n<h2 id=\"方法三-（目前效率最高\">方法三 （目前效率最高<a href=\"post/ORACLE之自动行号功能#方法三-（目前效率最高\"></a></h2><p>一、</p>\n<ol>\n<li>在记录块的PRE-QUERY中查询出数据库中已有的最大行号，并将其记录到参数中作为最大的行号，如果单据的头是新建的，那这个参数默认的最大值则为在行记录的WHEN-CREATE-RECORD中将最大行号的参数值+1赋给行号字段</li>\n<li>行号数据项的WHEN-VALIDATE-ITEM中检查行号是否&lt;0；同时检查行号在数据库中是否存在(对于同时录入多行相同的行号在这个触发器中无需处理)<br>在WHEN-NEW-RECORD-INSTANCE中检查如果块的状态是NEW，从数据库中获取最大的行号，并设置行号</li>\n<li>在WHEN-VALIDATE-RECORD中判断当前的行号是否大于参数中的最大行号，如果是则覆盖参数的最大行号  </li>\n</ol>\n<p>下面是将上面的代码按照HANDLER机制包装为LINE_NUM过程的列子：</p>\n<figure class=\"highlight plain\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">procedure line_num ( event varchar2) is  </span><br><span class=\"line\"> l_line_num_count number; </span><br><span class=\"line\">begin </span><br><span class=\"line\">   if ( event = &apos;WHEN-VALIDATE-ITEM&apos;) then    </span><br><span class=\"line\">   if :lines.line_number &lt;;= 0 then  </span><br><span class=\"line\">      fnd_message.set_name(&apos;XHU&apos;,&apos;XHU_ALL_ENTER_VALUE_GT_ZERO&apos;);  </span><br><span class=\"line\">      fnd_message.error; raise form_trigger_failure;  </span><br><span class=\"line\">   end if; -- check the unique line number from DB  </span><br><span class=\"line\">   if xhu_orders_sv.po_line_num_exists(name_in(&apos;headers.header_id&apos;),name_in(&apos;lines.line_number&apos;)then  </span><br><span class=\"line\">        fnd_message.set_name(&apos;XUH&apos;,&apos;XHU_ENTER_UNIQUE_LINE_NUM&apos;);  </span><br><span class=\"line\">         fnd_message.error;  </span><br><span class=\"line\">      raise form_trigger_failure;  </span><br><span class=\"line\">   end if;    </span><br><span class=\"line\">    elsif (event = &apos;WHEN-CREATE-RECORD&apos;) then  </span><br><span class=\"line\">          :lines.line_number := :parameter.max_line_num + 1;  </span><br><span class=\"line\"> elsif (event = &apos;PRE-QUERY&apos;) then -- get the maximums line number from the DB  </span><br><span class=\"line\">         :parameter.max_line_num := xhu_orders_sv.get_max_line_num(name_in(&apos;headers.header_id&apos;));  </span><br><span class=\"line\"> elsif (event = &apos;WHEN-VALIDATE-RECORD&apos;) then  </span><br><span class=\"line\">     if :lines.line_number &gt;; :parameter.max_line_num then  </span><br><span class=\"line\">   :parameter.max_line_num := :lines.line_number ;  </span><br><span class=\"line\">  end if;  </span><br><span class=\"line\"> elsif (event = &apos;WHEN-NEW-RECORD-INSTANCE&apos;)then  </span><br><span class=\"line\">   if upper(get_block_property(&apos;lines&apos;,status)) = upper(&apos;NEW&apos;) and :System.Mode &lt;;&gt;; &apos;ENTER-QUERY&apos; then  </span><br><span class=\"line\">  :parameter.max_line_num := xhu_orders_sv.get_max_line_num(name_in(&apos;headers.header_id&apos;)); line_num(&apos;WHEN-CREATE-RECORD&apos;);  </span><br><span class=\"line\">       SET_RECORD_PROPERTY(get_block_property(&apos;lines&apos;,current_record), &apos;lines&apos;, STATUS, NEW_STATUS );   </span><br><span class=\"line\">       end if;  </span><br><span class=\"line\">  else APP_EXCEPTION.INVALID_ARGUMENT(&apos;LINE_NUMBER&apos;, &apos;EVENT&apos;, EVENT);  </span><br><span class=\"line\">  end if;    </span><br><span class=\"line\">      exception  </span><br><span class=\"line\">  when others  </span><br><span class=\"line\">THEN raise;  </span><br><span class=\"line\">end line_num;    </span><br><span class=\"line\">--headers:单据的头数据块  </span><br><span class=\"line\">--lines：行号所属的数据块  </span><br><span class=\"line\">--xhu_orders_sv.get_max_line_num：根据头ID取得数据库中单据的最大行号  </span><br><span class=\"line\">--XHU_ENTER_UNIQUE_LINE_NUM：消息字典：请输入唯一行号  </span><br><span class=\"line\">--XHU_ALL_ENTER_VALUE_GT_ZERO：消息字典：请输入大于0的值</span><br></pre></td></tr></table></div></figure>\n\n<p>各触发器的HANDLER：</p>\n<figure class=\"highlight plain\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">procedure when_create_record is  </span><br><span class=\"line\">begin lines.line_num(&apos;WHEN-CREATE-RECORD&apos;); </span><br><span class=\"line\">  end when_create_record;    </span><br><span class=\"line\">procedure when_new_record_instance is  </span><br><span class=\"line\">begin lines.line_num(&apos;WHEN-NEW-RECORD-INSTANCE&apos;);  </span><br><span class=\"line\">end when_new_record_instance;    </span><br><span class=\"line\">procedure when_validate_record is  </span><br><span class=\"line\">begin lines.line_num(&apos;WHEN-VALIDATE-RECORD&apos;); </span><br><span class=\"line\">  end when_validate_record;    </span><br><span class=\"line\">procedure pre_query is  </span><br><span class=\"line\">begin lines.line_num(&apos;PRE-QUERY&apos;);  </span><br><span class=\"line\">end pre_query;</span><br></pre></td></tr></table></div></figure>\n\n<p>添加一个MAX_LINE_NUM(NUMBER)的参数来保存当前最大行号的值</p>\n<p>二、</p>\n<p>在外部新建一个 xhu_orders_sv.get_max_line_num 的函数，返回header_id所在行里面最大的line_number,注意当查询结果为空时要返回0</p>\n","next":{"title":"如何优雅地使用RSS","link":"post/如何优雅地使用RSS"},"plink":"http://luer.cf/post/ORACLE之自动行号功能/","toc":[{"title":"方法一","id":"方法一","index":"1"},{"title":"方法二：","id":"方法二：","index":"2"},{"title":"方法三 （目前效率最高","id":"方法三-（目前效率最高","index":"3"}]}